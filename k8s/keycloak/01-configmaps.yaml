---
apiVersion: v1
kind: ConfigMap
metadata:
  name: keycloak-config
  namespace: tenant-management
data:
  KC_PROXY: "edge"
  KC_HOSTNAME: "governance.mrtmcloud.com"
  KC_HOSTNAME_STRICT: "true"
  KC_HOSTNAME_STRICT_HTTPS: "false"
  KC_HTTP_ENABLED: "true"
  KC_HEALTH_ENABLED: "true"
  KC_METRICS_ENABLED: "true"
  KC_LOG_LEVEL: "INFO"
  
---
apiVersion: v1
kind: Secret
metadata:
  name: keycloak-secrets
  namespace: tenant-management
type: Opaque
stringData:
  KEYCLOAK_ADMIN: "admin"
  KEYCLOAK_ADMIN_PASSWORD: "admin123"  # Change this in production
  KC_DB_USERNAME: "keycloak"
  KC_DB_PASSWORD: "keycloak123"  # Change this in production
  
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: keycloak-realm-import
  namespace: tenant-management
data:
  tenant-management-realm.json: |
    {
      "realm": "tenant-management",
      "enabled": true,
      "displayName": "Tenant Management System for CVS SaaS Apps",
      "displayNameHtml": "<style>#kc-logo-wrapper, .login-pf-page-header{display:none;}</style><div style='text-align:center;padding:50px 0 30px 0;'><div style='font-size:28px;font-weight:600;color:#1976d2;margin-bottom:12px;'>Tenant Management System</div><div style='font-size:20px;font-weight:400;color:#666;'>for CVS SaaS Apps</div></div>",
      "sslRequired": "external",
      "registrationAllowed": false,
      "loginWithEmailAllowed": true,
      "duplicateEmailsAllowed": false,
      "resetPasswordAllowed": true,
      "editUsernameAllowed": false,
      "bruteForceProtected": true,
      "accessTokenLifespan": 3600,
      "ssoSessionIdleTimeout": 86400,
      "ssoSessionMaxLifespan": 864000,
      "offlineSessionIdleTimeout": 2592000,
      "loginTheme": "cvs-light",
      "accountTheme": "keycloak",
      "adminTheme": "keycloak",
      "emailTheme": "keycloak",
      "internationalizationEnabled": false,
      "attributes": {
        "_browser_header.contentSecurityPolicy": "frame-src 'self'; frame-ancestors 'self'; object-src 'none';",
        "_browser_header.xContentTypeOptions": "nosniff",
        "_browser_header.xRobotsTag": "none",
        "_browser_header.xFrameOptions": "SAMEORIGIN",
        "_browser_header.xXSSProtection": "1; mode=block",
        "_browser_header.strictTransportSecurity": "max-age=31536000; includeSubDomains"
      },
      "roles": {
        "realm": [
          {
            "name": "admin",
            "description": "Administrator - full access to all features and tenants",
            "composite": false
          },
          {
            "name": "operator",
            "description": "Operator - can manage assigned tenants (start/stop/schedule)",
            "composite": false
          },
          {
            "name": "viewer",
            "description": "Viewer - read-only access to view all information",
            "composite": false
          }
        ]
      },
      "clients": [
        {
          "clientId": "tenant-manager-backend",
          "name": "Tenant Manager Backend API",
          "description": "Backend API service",
          "enabled": true,
          "protocol": "openid-connect",
          "publicClient": false,
          "bearerOnly": false,
          "serviceAccountsEnabled": true,
          "authorizationServicesEnabled": true,
          "directAccessGrantsEnabled": true,
          "standardFlowEnabled": true,
          "implicitFlowEnabled": false,
          "secret": "backend-client-secret-change-in-production",
          "redirectUris": ["*"],
          "webOrigins": ["*"],
          "attributes": {
            "access.token.lifespan": "3600"
          }
        },
        {
          "clientId": "tenant-manager-frontend",
          "name": "Tenant Manager Frontend",
          "description": "Frontend web application",
          "enabled": true,
          "protocol": "openid-connect",
          "publicClient": true,
          "bearerOnly": false,
          "standardFlowEnabled": true,
          "implicitFlowEnabled": false,
          "directAccessGrantsEnabled": true,
          "redirectUris": [
            "http://localhost:5173/*",
            "http://localhost:3000/*",
            "http://k8s-istiosys-istioing-a033e299eb-2401607831df82f9.elb.ap-south-1.amazonaws.com/*",
            "http://*",
            "https://*"
          ],
          "webOrigins": [
            "http://localhost:5173",
            "http://localhost:3000",
            "http://k8s-istiosys-istioing-a033e299eb-2401607831df82f9.elb.ap-south-1.amazonaws.com",
            "*"
          ],
          "attributes": {
            "pkce.code.challenge.method": "S256",
            "post.logout.redirect.uris": "+"
          }
        }
      ],
      "users": [
        {
          "username": "admin",
          "enabled": true,
          "emailVerified": true,
          "firstName": "Admin",
          "lastName": "User",
          "email": "admin@tenant-manager.local",
          "credentials": [
            {
              "type": "password",
              "value": "admin123",
              "temporary": false
            }
          ],
          "realmRoles": ["admin"],
          "clientRoles": {
            "realm-management": ["realm-admin"]
          }
        },
        {
          "username": "operator",
          "enabled": true,
          "emailVerified": true,
          "firstName": "Operator",
          "lastName": "User",
          "email": "operator@tenant-manager.local",
          "credentials": [
            {
              "type": "password",
              "value": "operator123",
              "temporary": false
            }
          ],
          "realmRoles": ["operator"]
        },
        {
          "username": "viewer",
          "enabled": true,
          "emailVerified": true,
          "firstName": "Viewer",
          "lastName": "User",
          "email": "viewer@tenant-manager.local",
          "credentials": [
            {
              "type": "password",
              "value": "viewer123",
              "temporary": false
            }
          ],
          "realmRoles": ["viewer"]
        }
      ],
      "clientScopes": [
        {
          "name": "roles",
          "protocol": "openid-connect",
          "attributes": {
            "include.in.token.scope": "true",
            "display.on.consent.screen": "true"
          },
          "protocolMappers": [
            {
              "name": "realm roles",
              "protocol": "openid-connect",
              "protocolMapper": "oidc-usermodel-realm-role-mapper",
              "consentRequired": false,
              "config": {
                "multivalued": "true",
                "userinfo.token.claim": "true",
                "id.token.claim": "true",
                "access.token.claim": "true",
                "claim.name": "realm_access.roles",
                "jsonType.label": "String"
              }
            }
          ]
        },
        {
          "name": "email",
          "description": "OpenID Connect built-in scope: email",
          "protocol": "openid-connect",
          "attributes": {
            "include.in.token.scope": "true",
            "display.on.consent.screen": "true",
            "consent.screen.text": "${emailScopeConsentText}"
          },
          "protocolMappers": [
            {
              "name": "email",
              "protocol": "openid-connect",
              "protocolMapper": "oidc-usermodel-property-mapper",
              "consentRequired": false,
              "config": {
                "userinfo.token.claim": "true",
                "user.attribute": "email",
                "id.token.claim": "true",
                "access.token.claim": "true",
                "claim.name": "email",
                "jsonType.label": "String"
              }
            },
            {
              "name": "email verified",
              "protocol": "openid-connect",
              "protocolMapper": "oidc-usermodel-property-mapper",
              "consentRequired": false,
              "config": {
                "userinfo.token.claim": "true",
                "user.attribute": "emailVerified",
                "id.token.claim": "true",
                "access.token.claim": "true",
                "claim.name": "email_verified",
                "jsonType.label": "boolean"
              }
            }
          ]
        },
        {
          "name": "profile",
          "description": "OpenID Connect built-in scope: profile",
          "protocol": "openid-connect",
          "attributes": {
            "include.in.token.scope": "true",
            "display.on.consent.screen": "true",
            "consent.screen.text": "${profileScopeConsentText}"
          },
          "protocolMappers": [
            {
              "name": "username",
              "protocol": "openid-connect",
              "protocolMapper": "oidc-usermodel-property-mapper",
              "consentRequired": false,
              "config": {
                "userinfo.token.claim": "true",
                "user.attribute": "username",
                "id.token.claim": "true",
                "access.token.claim": "true",
                "claim.name": "preferred_username",
                "jsonType.label": "String"
              }
            },
            {
              "name": "full name",
              "protocol": "openid-connect",
              "protocolMapper": "oidc-full-name-mapper",
              "consentRequired": false,
              "config": {
                "userinfo.token.claim": "true",
                "id.token.claim": "true",
                "access.token.claim": "true"
              }
            },
            {
              "name": "given name",
              "protocol": "openid-connect",
              "protocolMapper": "oidc-usermodel-property-mapper",
              "consentRequired": false,
              "config": {
                "userinfo.token.claim": "true",
                "user.attribute": "firstName",
                "id.token.claim": "true",
                "access.token.claim": "true",
                "claim.name": "given_name",
                "jsonType.label": "String"
              }
            },
            {
              "name": "family name",
              "protocol": "openid-connect",
              "protocolMapper": "oidc-usermodel-property-mapper",
              "consentRequired": false,
              "config": {
                "userinfo.token.claim": "true",
                "user.attribute": "lastName",
                "id.token.claim": "true",
                "access.token.claim": "true",
                "claim.name": "family_name",
                "jsonType.label": "String"
              }
            }
          ]
        }
      ],
      "defaultDefaultClientScopes": [
        "roles",
        "email",
        "profile"
      ]
    }
